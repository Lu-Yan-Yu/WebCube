<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Geospatial API AR</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=visualization">
    </script>
    <style>
        #map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <div id="map"></div>
    <button id="start-ar" style="position: absolute; top: 10px; left: 10px; z-index: 10;">
        启动 AR
    </button>

    <a-scene embedded arjs>
        <!-- 模型 -->
        <a-entity id="shapeEntity"
                  geometry="primitive: box; height: 0.5; width: 0.5; depth: 0.5"
                  material="color: rgb(70, 130, 180)">
        </a-entity>
        <!-- 摄像头 -->
        <a-camera gps-camera></a-camera>
    </a-scene>

    <script>
        async function initializeGeospatial() {
            const status = document.createElement("div");
            status.style.position = "absolute";
            status.style.top = "50px";
            status.style.left = "10px";
            status.style.color = "white";
            document.body.appendChild(status);

            if (!navigator.xr) {
                status.innerText = "您的设备不支持 WebXR。";
                console.error("WebXR not supported.");
                return;
            }

            try {
                const supported = await navigator.xr.isSessionSupported("immersive-ar");
                if (!supported) {
                    status.innerText = "您的设备不支持 Immersive AR。";
                    console.error("Immersive AR not supported.");
                    return;
                }

                status.innerText = "设备支持 Immersive AR，正在检查 Geospatial 支持...";
                const session = await navigator.xr.requestSession("immersive-ar", {
                    requiredFeatures: ["local-floor", "geospatial"],
                });

                if (!session) {
                    status.innerText = "无法创建带 Geospatial 功能的 AR 会话。";
                    console.error("Failed to start AR session.");
                    return;
                }

                status.innerText = "Geospatial API 已启用！";
                console.log("Geospatial session started:", session);

                initializeGoogleMapsGeospatial();
            } catch (error) {
                status.innerText = "初始化 Geospatial 失败：" + error.message;
                console.error("Failed to initialize Geospatial:", error);
            }
        }

        function initializeGoogleMapsGeospatial() {
            const map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 22.998774, lng: 120.219917 },
                zoom: 15,
            });

            new google.maps.Marker({
                position: { lat: 22.998774, lng: 120.219917 },
                map: map,
                title: "目标位置",
            });

            console.log("Google Maps Geospatial 初始化完成！");
        }

        document.getElementById("start-ar").addEventListener("click", () => {
            initializeGeospatial();
        });
    </script>
</body>
</html>
